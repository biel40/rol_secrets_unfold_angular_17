<div class="npc-dialog-container">
    <!-- Header with title and close button -->
    <div class="dialog-header">
        <div class="header-content">
            <mat-icon class="header-icon">{{ isEditMode ? 'edit' : 'person_add' }}</mat-icon>
            <h2>{{ isEditMode ? ('edit-npc' | transloco) : ('create-npc' | transloco) }}</h2>
        </div>
        <button mat-icon-button (click)="closeDialog()" class="close-button">
            <mat-icon>close</mat-icon>
        </button>
    </div>

    <!-- Main content area -->
    <mat-dialog-content>
        <form [formGroup]="npcForm">
            <!-- Two-column layout for desktop -->
            <div class="form-layout">
                <!-- Left column: Form fields -->
                <div class="form-fields">
                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <mat-icon>info</mat-icon>
                            {{ 'basic-info' | transloco }}
                        </h3>

                        <!-- Name field -->
                        <mat-form-field appearance="outline">
                            <mat-label>{{ 'npc-name' | transloco }}</mat-label>
                            <mat-icon matPrefix>person</mat-icon>
                            <input matInput formControlName="name" required> 
                            @if (npcForm.get('name')?.hasError('required')) {
                                <mat-error>{{ 'name-required' | transloco }}</mat-error>
                            }
                        </mat-form-field>

                        <!-- Description field -->
                        <mat-form-field appearance="outline">
                            <mat-label>{{ 'description' | transloco }}</mat-label>
                            <textarea matInput formControlName="description" rows="3"></textarea>
                            <mat-hint>{{ 'description-hint' | transloco }}</mat-hint> 
                            @if (npcForm.get('description')?.hasError('maxlength')) {
                                <mat-error>{{ 'description-max-length' | transloco }}</mat-error>
                            }
                        </mat-form-field>
                    </div>

                    <!-- Image Section -->
                    <div class="form-section image-section">
                        <h3 class="section-title">
                            <mat-icon>image</mat-icon>
                            {{ 'image-details' | transloco }}
                        </h3>

                        <!-- Image URL field -->
                        <div class="image-url-field">
                            <mat-form-field appearance="outline">
                                <mat-label>{{ 'image-url' | transloco }}</mat-label>
                                <mat-icon matPrefix>link</mat-icon>
                                <input matInput formControlName="img_url" required>
                                <mat-hint>{{ 'image-url-hint' | transloco }}</mat-hint> 
                                @if (npcForm.get('img_url')?.hasError('required')) {
                                    <mat-error>{{ 'image-url-required' | transloco }}</mat-error>
                                }
                            </mat-form-field>
                        </div>
                    </div>
                </div>

                <!-- Right column: Image preview -->
                <div class="image-preview-container">
                    <div class="image-card">
                        <div class="image-header">
                            <mat-icon>preview</mat-icon>
                            <span>{{ 'image-preview' | transloco }}</span>
                        </div>
                        <div class="image-content" [class.empty]="!npcForm.get('img_url')?.value"
                            [class.loading]="imageLoading"> @if (imageLoading) {
                            <div class="loading-spinner">
                                <mat-spinner diameter="40"></mat-spinner>
                                <p>{{ 'loading-image' | transloco }}</p>
                            </div>
                            } 

                            @if (npcForm.get('img_url')?.value && !imageLoading && !imageError) {
                            <img [src]="npcForm.get('img_url')?.value" alt="NPC Image Preview" (load)="onImageLoad()"
                                (error)="onImageError()" @imageAnimation>
                            } 

                            @if (imageError) {
                                <div class="error-placeholder">
                                    <mat-icon>broken_image</mat-icon>
                                    <p>{{ 'image-load-error' | transloco }}</p>
                                </div>
                            } 

                                @if (!npcForm.get('img_url')?.value && !imageLoading) {
                                <div class="placeholder">
                                    <mat-icon>image_not_supported</mat-icon>
                                    <p>{{ 'no-image' | transloco }}</p>
                                </div>
                            }
                        </div> 
                        
                        @if (npcForm.get('name')?.value) {
                        <div class="character-preview" @fadeIn>
                            <div class="preview-header">
                                <h4>{{ npcForm.get('name')?.value }}</h4>
                                <span class="npc-type-badge">{{ 'npc' | transloco }}</span>
                            </div>
                            <div class="preview-details">

                                @if (npcForm.get('occupation')?.value) {
                                <div class="detail-item">
                                    <mat-icon>work</mat-icon>
                                    <span>{{ npcForm.get('occupation')?.value }}</span>
                                </div>
                                }

                                @if (npcForm.get('location')?.value) {
                                <div class="detail-item">
                                    <mat-icon>place</mat-icon>
                                    <span>{{ npcForm.get('location')?.value }}</span>
                                </div>
                                }
                            </div>
                        </div>
                        }
                    </div>
                </div>
            </div>
        </form>
    </mat-dialog-content>

    <!-- Action buttons -->
    <mat-dialog-actions>
        <button mat-button (click)="closeDialog()" class="cancel-button">
            <mat-icon>cancel</mat-icon>
            {{ 'cancel' | transloco }}
        </button>
        <button mat-raised-button color="primary" [disabled]="npcForm.invalid || isSubmitting" (click)="saveNPC()"class="save-button"> 
            @if (isSubmitting) {
            <mat-spinner diameter="20"></mat-spinner>
            }

            @if (!isSubmitting) {
            <span>{{ isEditMode ? ('update' | transloco) : ('create' | transloco) }}</span>
            }
        </button>
    </mat-dialog-actions>
</div>